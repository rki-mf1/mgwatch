{% extends "mgw_api/base.html" %}

{% block content %}

{% load static %}

{% load custom_filters %}

<div class="result-navigation">
    <h2>{{ result.name }}</h2>
    <a href="{% url 'mgw_api:list_result' %}">Back to Watches</a>
    <form id="watch-form" method="post" action="{% url 'mgw_api:toggle_watch' result.pk %}">
        {% csrf_token %}
        <label><input type="checkbox" name="is_watched" {% if result.is_watched %}checked{% endif %} onchange="submitWatchForm()">Watched</label>
    </form>
    <a href="{% url 'mgw_api:download_full_table' result.pk %}">Download (all)</a>
    <a href="{% url 'mgw_api:download_filtered_table' result.pk %}">Download (filtered)</a>
    <a href="{% url 'mgw_api:delete_result' result.pk %}?next={% url 'mgw_api:result_table' result.pk %}">Delete this Result</a>
</div>

<div class="result-table">
    <div class="table-wrapper">
        <table>
            <thead id="table-head">
                <tr>
                    {% for header in headers %}
                        <th onclick="sortTable({{ forloop.counter0 }})">
                            {{ header }}
                            <span onclick="sortTable({{ forloop.counter0 }}); event.stopPropagation();">
                            {% if forloop.counter0 == sort_column %}
                                {% if sort_reverse %}▼{% else %}▲{% endif %}
                            {% else %} {% endif %}
                            </span>
                        </th>
                    {% endfor %}
                </tr>
                <tr>
                    {% for header in headers %}
                        <th>
                            {% if forloop.counter0|in_list:numeric_columns %}
                                <input type="text" class="filter-input-min" placeholder="Min" data-column="{{ forloop.counter0 }}" value="{{ filter_form.instance.range_filters|get_min:forloop.counter0|default_if_none:'' }}" title="Supports regular expressions if not a number">
                                <input type="text" class="filter-input-max" placeholder="Max" data-column="{{ forloop.counter0 }}" value="{{ filter_form.instance.range_filters|get_max:forloop.counter0|default_if_none:'' }}" title="Supports regular expressions if not a number">
                            {% else %}
                                <input type="text" class="filter-input" placeholder="Filter" data-column="{{ forloop.counter0 }}" value="{{ filter_form.instance.filters|get_item:forloop.counter0|default_if_none:'' }}" title="Supports regular expressions">
                            {% endif %}
                        </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="table-body">
                {% for row in rows %}
                    <tr>
                        {% for cell, header in row|zip_lists:headers %}
                            <td>
                                {% if header == "sra link" or header == "biosample link" %}
                                    <a href="{{ cell }}" target="_blank">{{ cell|last_part_of_url }}</a>
                                {% elif header == "containment" or header == "query containment ani" %}
                                    {{ cell|floatformat:4 }}
                                {% elif header == "lat lon" %}
                                    {% if cell != "NP" %}
                                        <a href="https://www.openstreetmap.org/#map=12/{{ cell|urlencode }}">view map</a>
                                    {% endif %}
                                {% elif cell == "NP" %}
                                {% else %}
                                    {{ cell }}
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<script>
    function handleError(message) {
        submissionMessageDiv.style.display = 'block';
        submissionMessageDiv.innerHTML = `<ul class="messages"><li class="error">An error occurred: ${message}</li></ul>`;
    }

    function submitWatchForm() {
        const form = document.getElementById('watch-form');
        const formData = new FormData(form);
    
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData,
        }).then(response => {
            if (!response.ok) {
                handleError('Failed to update the watch status.');
            }
        }).catch(error => {
            handleError(error.message);
        });
    }

    document.querySelectorAll('.filter-input, .filter-input-min, .filter-input-max').forEach(function(input) {
        input.addEventListener('input', function() {
            const column = this.getAttribute('data-column');
            const min_input = document.querySelector(`.filter-input-min[data-column='${column}']`);
            const max_input = document.querySelector(`.filter-input-max[data-column='${column}']`);
    
            const min_value = min_input ? min_input.value : null;
            const max_value = max_input ? max_input.value : null;
            const value = !min_input && !max_input ? this.value : null;
    
            fetch("{% url 'mgw_api:update_filters' result.pk %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ column: column, min_value: min_value, max_value: max_value, value: value })
            }).then(response => {
                if (response.ok) {
                    reloadTableBody();
                } else {
                    handleError('Failed to update filter settings.');
                }
            }).catch(error => {
                handleError(error.message);
            });
        });
    });

    let currentSortColumn = null;
    let currentSortReverse = false;
    function sortTable(column) {
        if (currentSortColumn === column) {
            currentSortReverse = !currentSortReverse;
        } else {
            currentSortColumn = column;
            currentSortReverse = false;
        }
    
        fetch("{% url 'mgw_api:update_sort' result.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ column: column, sort_reverse: currentSortReverse })
        }).then(response => {
            if (response.ok) {
                response.json().then(data => {
                    updateSortIcons(column, currentSortReverse);
                    reloadTableBody();
                });
            } else {
                handleError('Failed to update sort settings.');
            }
        }).catch(error => {
            handleError(error.message);
        });
    }

    function updateSortIcons(sortedColumn, sortReverse) {
        const headers = document.querySelectorAll('#table-head th span');
        headers.forEach((header, index) => {
            if (index === sortedColumn) {
                header.innerHTML = sortReverse ? '▼' : '▲';
            } else {
                header.innerHTML = ' ';
            }
        });
    }

    function reloadTableBody() {
        fetch("{% url 'mgw_api:result_table' result.pk %}", {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.json()).then(data => {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            data.rows.forEach(row => {
                const rowElement = document.createElement('tr');
                row.forEach((cell, index) => {
                    const cellElement = document.createElement('td');
                    const header = data.headers[index].toLowerCase();
                    if (header === 'sra link' || header === 'biosample link') {
                        const linkElement = document.createElement('a');
                        linkElement.href = cell;
                        linkElement.target = '_blank';
                        linkElement.textContent = cell.split('/').pop();
                        cellElement.appendChild(linkElement);
                    } else if (header === 'containment' || header === 'query containment ani') {
                        cellElement.textContent = parseFloat(cell).toFixed(4);
                    } else if (cell === 'NP') {
                        cellElement.textContent = '';
                    } else {
                        cellElement.textContent = cell;
                    }
                    rowElement.appendChild(cellElement);
                });
                tableBody.appendChild(rowElement);
            });
            createCountryAndLLMap(data);
        }).catch(error => {
            handleError(error.message);
        });
    }
</script>

{% endblock %}








